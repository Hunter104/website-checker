#!/usr/bin/bash

exec 3>&1
set -euo pipefail

# HOOK_URL is an environment variable
readonly WEBSITE_DB="/var/lib/check_site/websites"
readonly LOGFILE="/var/log/check_site.log"

log() {
  local message="$1"
  local level="${2:-INFO}"
  
  local timestamp="[$(date -Is)]"

  if [[ $level == ERROR ]]; then 
    echo "$timestamp [ERROR] $message" | tee -a "$LOGFILE" >&2
  else 
    echo "$timestamp [$level] $message" | tee -a "$LOGFILE" 1>&3
  fi
}

format_message() {
  [[ $1 == UP ]] && echo "✅ **$2** está online!" || echo "❌ **$2** caiu!"
}

check_status() {
  local url="$1"
  local name="$2"
  local status_code=$(curl -Is --retry 5 --max-time 20 -L -w "%{http_code}" -o /dev/null "$1")
  local exit_code=$?

  if [[ $exit_code -eq 28 ]]; then 
    log "Timeout while checking $name ($url)"
    log "Setting status to DOWN"
  elif [[ $exit_code -ne 0 ]]; then 
    log "Curl error while checking $name ($url), exit code: $exit_code" "ERROR"
    log "Assuming status is DOWN"
  else
    log "Response for $name ($url): $status_code"
  fi

  [[ $status_code == 200 ]] \
    && echo "UP" \
    || echo "DOWN"
}

check_network() {
  if ping -c 1 8.8.8.8 &>/dev/null; then
    return 0
  else 
    return 1
  fi
}

if [[ ! -f $WEBSITE_DB ]]; then 
  log "Website database not found at $WEBSITE_DB." "ERROR"
  exit 1
fi

if [[ -z "$HOOK_URL" ]]; then 
  log "HOOK_URL environment variable is not set." "ERROR"
  exit 1
fi

temp_db=$(mktemp) || { log "Failed to create temporary database file" "ERROR"; exit 1; }

while IFS=' ' read -r url name last_status last_timestamp; do 
  if ! check_network; then 
    log "Network is down, skipping website checks." "ERROR"
    continue
  fi
  status=$(check_status "$url" "$name")

  if [[ $status != $last_status ]]; then 
    log "$name changed to $status"
    curl -H "Content-Type: application/json" -X POST \
      -d "{\"content\":\"$(format_message "$status" "$name")\"}" "$HOOK_URL"
  else 
    log "$name remains $last_status"
  fi

  echo "$url $name $status $(date -Is)" >> "$temp_db"
done < "$WEBSITE_DB"

mv "$temp_db" "$WEBSITE_DB"
